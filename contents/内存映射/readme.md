# 概述

`mmap()` 系统调用在调用进程的虚拟地址空间中创建一个新的内存映射，映射分为两种：

- 文件映射：将一个文件的一部分直接映射到调用进程的虚拟内存中，一旦一个文件被映射之后，就可以通过在相应的内存区域中操作字节来访问文件内容，映射的分页会在需要的时候从文件中自动加载，这种映射也称为基于文件的映射或内存映射文件
- 匿名映射：没有对应的文件，相反，这种映射的分页会被初始化为 0

一个进程的映射中的内存可以与其他进程中的映射共享(即各个子进程的页表条目指向 RAM 中相同的分页)。这种情况会存在2种情况发生：

- 当两个进程映射了一个文件的同一个区域时，它们会共享物理内存的相同分页
- 通过 `fork()` 创建的子进程会继承父进程的映射的副本，并且这些映射所引用的物理内存分页与父进程中相应映射所引用的分页相同

当两个或者多个进程共享相同分页时，每个进程都有可能看到其他进程对分页内容作出的改变，这当然要取决于映射是私有的还是共享的：

- 私有映射(`MAP_PRIVATE`) ：在映射内容上发生的变更对其他进程是不可见的，对于文件映射来说，变更将不会在底层文件上进行。尽管一个私有映射的分页在上面介绍的情况中，  初始时是共享的，但对映射内容作出的变更对各个进程来讲是私有的。内核使用了写时复制技术完成了这个任务。这意味着，当一个进程试图修改一个分页  的内容时，内核首先会为该进程创建一个新分页，并将需要修改的分页中的内容复制到新分页中(以及调整进程的页表)。正因为这个原因，`MAP_PRIVATE`   映射会被称为私有，写时复制映射
- 共享映射(`MAP_SHARED`)：在映射内容上发生的变更对所有共享同一个映射的其他进程都是可见的，对于文件映射来说，变更将会发生在底层文件上

各种映射的用途：

![](./img/memmap.png)

- 私有文件映射：映射的内容被初始化为一个而文件区域的内容。多个映射同一个文件的进程初始时会共享同样的内存物理分页，但系统使用写时复制技术使得一个进程对映射所做的变更对其他进程不可见。这种映射的主要用途是使用一个文件的内容来来初始化一块内存区域。一些常见的例子包括根据二进制可执行文件或共享文件的相应部分来初始化一个进程的文件和数据段
- 私有匿名映射：每次调用 `mmap()` 创建一个私有映射时都会产生一个新映射，该映射与同一进程创建的其他匿名映射是不同的(即不会共享物理分页)。尽管子进程会继承父进程的映射，但写时复制语义确保了 `fork()` 之后父进程和子进程不会看到其他进程对映射所做的变更。匿名映射的主要用途是为一个进程分配新(用0填充)的内存(如在分配大块内存时用 `malloc()`  会为此使用 `mmap()`)
- 共享文件映射：所有映射一个文件同一区域的进程会共享同样的内存物理分页，这些分页的内容将被初始化为该文件区域。对映射内容的修改将直接在文件中进行。这种映射主要用于2个用途：
  -  允许内存映射 IO, 这表示一个文件会被加载到进程的虚拟内存中的一个区域中并且对该区域的变更会自动被写入到这个文件中。因此，内存映射 IO 为使用 `read()`，`write()` 来执行文件 IO  这种做法提供了一种替代方案。
  - 允许无关进程共享一块内容以便以一种类似于 System V 共享内存段的方式来执行(快速) IPC
- 共享匿名映射：与私有匿名映射一样，每次调用 `mmap()` 创建一个共享匿名映射时都会产生一个新的，与任何其他映射不共享分页的截然不同的映射。这里的区别是映射的分页不会被写时复制。这意味着， 当一个子进程在 `fork()` 之后继承映射，父进程和子进程共享同一的 RAM 分页，并且一个进程对映射内容所作出的变更会对其他进程可见。共享匿名映射允许以一种类似于 System V 共享内存段的方式来进行 IPC，但只有相关进程可以这么做

 一个进程在执行 `exec()` 后映射会丢失，但通过 `fork()` 创建的子进程会继承映射，映射类型(`MAP_PRIVATE` 和 `MAP_SHARED`) 也会被继承。

通过 Linux 下特有的 `/proc/PID/maps` 文件能够查看与一个进程的映射有关的所有信息。

# 创建一个映射

```
#include <sys/mman.h>

void *mmap(void *addr, size_t length, int prot, int flags,int fd, off_t offset);
int munmap(void *addr, size_t length);
```

- `addr` 建立映射区的首地址，由 Linux 内核指定。用户程序调用时直接传递 `NULL`，那么内核会为映射选择一个合适地址，如果不是 `NULL`，内核会再选择将映射放置在何处时将这个参数值作为一个提示信息来处理
- 成功时返回创建的映射区首地址，失败时返回 `MAP_FAILED`
- `length` 指定了映射的字节数，尽管 `length` 无需是一个系统分页大小的倍数，但是内核会以分页大小为单位来创建映射，因此，实际上 `lenght` 会被向上提升为分页大小的下一个倍数
- `prot` 映射区的权限：

![](./img/bits.png)

- `flags` 标志位参数，常用于设定更新物理区域、设置共享、创建匿名映射区：
  - `MAP_SHARED`：创建一个共享映射，映射区所做的修改会反映到物理设备（磁盘）上
  - `MAP_PRIVATE`：创建一个私有映射，映射区所做的修改不会反映到物理设备上
- `fd` 是用来建立映射区的文件描述符。
- `offset` 映射文件的偏移量（4k 的整数倍），可以映射整个文件，也可以只映射一部分内容。



2.文件映射
	创建一个文件映射的步骤：
	1.获取一个文件的描述符，通常通过调用 open() 来获取
	2.将文件描述符作为 fd 参数，传入 mmap() 中