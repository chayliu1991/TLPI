# 核心转储文件

所谓的核心转储是内含进程终止时内存映像的一个文件。术语 `core` 源于老迈的内存技术，将该内存映像加载到调试器中，即可查明信号到达时程序代码和数据的状态。

生成 `core` 文件：

```
ulimit -c unlimited
sleep 30

Type control+\  # 产生 SIFQUIT 信号，必杀之
Quit (core dumped)
ls -l core
-rw------- 1 ubuntu ubuntu 389120 7月   7 19:49 core
```

- 核心转储文件创建于进程的当前工作目录中，名为 `core` ，这是核心转储文件的默认位置和名称

## 不产生核心转储文件的情况

- 进程对于核心转储文件没有写权限，造成这种情况的原因有：进程对将要创建核心转储文件的所在目录没有写权限，或者因为存在同名(且不可写，亦或是非常规类型)文件
- 存在一个同名、可写的普通文件，但指向该文件硬链接数超过一个
- 将要创建核心转储文件的所在目录并不存在
- 把进程 "核心转储文件大小" 这一资源限制为 0
- 将进程 "可创建文件大小"这一资源限制为 0
- 对进程正在执行的二进制可执行文件没有读权限，这样就防止了用户借助于核心转储文件来获取本无法读取的程序代码
- 以只读方式挂载当前工作目录所在的文件系统，或者文件系统空间已满，又或者 `i-node` 资源耗尽，还有一种情况，即用户已经达到其在该文件系统上的配额限制
- `Set-user-ID` (`Set-group-ID`) 程序在由非文件属主(属组)执行时，不会产生核心转储文件，这可以防止恶意用户将一个安全程序的内存转储出来，再针对诸如密码之类的敏感信息进行刺探

`/proc/PID/coredump_filter` 可以对写入核心转储文件的内存映射类型施以进程级控制，该文件中的值是一个 4 位掩码，分别对应于 4 种类型的内存映射：

- 私有匿名映射
- 私有文件映射
- 共享匿名映射
- 共享文件映射

默认仅对匿名映射和共享匿名映射进行转储。

## 为核心转储文件命名

`/proc/sys/kernel/core_pattern` 文件所包含的格式化字符串来控制对系统上生成的所有核心转储文件的命名，默认情况下是 `core`。

文件说明符：

![](./img/core_pattern.png)

替换所有格式说明符后，由此生成的路径名字符长度最多可达 128 个字符。

# 传递、处置及处理的特殊情况

## SIGKILL 和 SIGSTOP

`SIGKILL ` 信号的默认行为是终止一个进程，`SIGSTOP` 信号的默认行为是停止一个进程，二者的默认行为均无法改变。当试图调用 `signal()` 和 `sigaction()` 来改变对这些信号的处置时，将总是返回错误。同样，也不能将这两个信号阻塞。

## SIGCONT 和停止信号

`SIGCONT ` 信号来使 因接收  `SIGSTOP`，`SIGTSTP`，`SIGTTIN`，`SIGTTOU` 等信号而处于停止状态的进程得以继续运行。

如果一个进程处于停止状态，那么当 `SIGCONT` 信号到达时总是会使其恢复运行，即使该进程正在阻塞或者忽略 `SIGCONT` 信号。

如果有任一其他信号发送给一个已经停止的进程，那么在进程收到 `SIGCONT` 信号而恢复运行之前，信号实际上并未传递，`SIGKILL` 信号则属于例外，因为该信号总是会杀死进程，即使进程当前处于停止状态。

## 由终端产生的信号若已被忽略，则不应改变其信号处置

如果程序在执行时发现，已将对由终端产生信号的处置置为 `SIG_IGN`，那么程序通常不应该试图去改变信号处置，这并非系统硬性规定，而是惯例，与之相关的信号有：`SIGHUP`，`SIGINT`，`SIGQUIT`，`SIGTTIN`，`SIGTTOU`，`SIGTSTP`。











